import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

interface ProcessMessageRequest {
  tenant_id: string;
  customer_phone: string;
  message: string;
  group_name?: string;
}

Deno.serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const supabaseUrl = Deno.env.get('SUPABASE_URL')!;
    const supabaseKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!;
    const supabase = createClient(supabaseUrl, supabaseKey);

    const body: ProcessMessageRequest = await req.json();
    const { tenant_id, customer_phone, message, group_name } = body;

    console.log('\nüîÑ ===== PROCESSANDO MENSAGEM WHATSAPP =====');
    console.log('üè¢ Tenant:', tenant_id);
    console.log('üì± Telefone RECEBIDO:', customer_phone);
    console.log('üí¨ Mensagem:', message);
    if (group_name) {
      console.log('üë• Grupo WhatsApp:', group_name);
    }

    // Detectar c√≥digos de produtos (C seguido de n√∫meros)
    const productCodeRegex = /C(\d+)/gi;
    const matches = message.matchAll(productCodeRegex);
    const codes: string[] = [];
    
    for (const match of matches) {
      codes.push(match[0].toUpperCase()); // C101, C202, etc
    }

    if (codes.length === 0) {
      console.log('‚ùå Nenhum c√≥digo de produto detectado');
      return new Response(
        JSON.stringify({ message: 'Nenhum c√≥digo de produto detectado' }),
        { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    console.log('‚úÖ C√≥digos detectados:', codes);

    // Normalizar telefone brasileiro com regra do nono d√≠gito
    function normalizePhoneBrazil(phone: string): string {
      // Remover tudo que n√£o √© n√∫mero
      let clean = phone.replace(/\D/g, '');
      
      console.log(`üîç Telefone original (limpo): ${clean} (${clean.length} d√≠gitos)`);
      
      // Remover c√≥digo do pa√≠s (55) se tiver
      if (clean.startsWith('55')) {
        clean = clean.substring(2);
        console.log(`‚úÇÔ∏è Removido DDI 55: ${clean}`);
      }
      
      // Validar tamanho m√≠nimo
      if (clean.length < 10) {
        console.warn(`‚ö†Ô∏è Telefone muito curto: ${phone} -> ${clean}`);
        return clean;
      }
      
      // Se o n√∫mero tem mais de 11 d√≠gitos, est√° mal formatado
      // Vamos tentar corrigir pegando apenas os 11 √∫ltimos d√≠gitos
      if (clean.length > 11) {
        console.warn(`‚ö†Ô∏è Telefone com ${clean.length} d√≠gitos (esperado: 11 ou menos)`);
        console.log(`üîß Tentando corrigir pegando os 11 √∫ltimos d√≠gitos...`);
        clean = clean.substring(clean.length - 11);
        console.log(`‚úÖ Telefone corrigido: ${clean}`);
      }
      
      // Extrair DDD (2 d√≠gitos) e n√∫mero
      const ddd = parseInt(clean.substring(0, 2));
      let number = clean.substring(2);
      
      console.log(`üìû Normalizando: DDD=${ddd}, N√∫mero=${number} (${number.length} d√≠gitos)`);
      
      // Garantir que o n√∫mero tenha 8 ou 9 d√≠gitos
      if (number.length > 9) {
        console.warn(`‚ö†Ô∏è N√∫mero com ${number.length} d√≠gitos (esperado: 8 ou 9)`);
        // Pegar apenas os 9 √∫ltimos d√≠gitos
        number = number.substring(number.length - 9);
        console.log(`üîß N√∫mero corrigido: ${number}`);
      }
      
      if (ddd >= 31) {
        // DDD >= 31 (SP, MG, Sul, etc): REMOVER o 9¬∫ d√≠gito se tiver
        if (number.length === 9 && number.startsWith('9')) {
          number = number.substring(1);
          console.log(`‚úÇÔ∏è DDD ${ddd} >= 31: Removendo 9¬∫ d√≠gito -> ${number}`);
        }
      } else {
        // DDD <= 30 (Norte, Nordeste): ADICIONAR o 9¬∫ d√≠gito se n√£o tiver
        if (number.length === 8) {
          number = '9' + number;
          console.log(`‚ûï DDD ${ddd} <= 30: Adicionando 9¬∫ d√≠gito -> ${number}`);
        }
      }
      
      const final = `${ddd}${number}`;
      console.log(`‚úÖ Telefone normalizado: ${final} (${final.length} d√≠gitos)`);
      return final;
    }

    const phoneNormalized = normalizePhoneBrazil(customer_phone);
    
    console.log('\nüìû ===== NORMALIZA√á√ÉO DE TELEFONE =====');
    console.log('üì• Telefone original:', customer_phone);
    console.log('üì§ Telefone normalizado:', phoneNormalized);
    console.log('===== FIM NORMALIZA√á√ÉO =====\n');

    // Data de hoje
    const today = new Date().toISOString().split('T')[0];

    // Processar cada c√≥digo detectado
    const results = [];
    
    for (const code of codes) {
      console.log(`\nüîç ===== PROCESSANDO C√ìDIGO: ${code} =====`);

      // 1. Buscar produto no banco (case-insensitive)
      console.log(`üîé Buscando produto com c√≥digo: ${code}`);
      
      const { data: product, error: productError } = await supabase
        .from('products')
        .select('*')
        .eq('tenant_id', tenant_id)
        .ilike('code', code) // Busca case-insensitive
        .eq('is_active', true)
        .maybeSingle();

      if (productError || !product) {
        console.error(`‚ùå Produto ${code} n√£o encontrado:`, productError);
        results.push({ code, success: false, error: 'Produto n√£o encontrado' });
        continue;
      }

      console.log(`‚úÖ Produto encontrado: ${product.name}`);
      console.log(`   Pre√ßo: R$ ${product.price}`);
      console.log(`   Estoque: ${product.stock}`);

      // 2. Verificar estoque
      if (product.stock <= 0) {
        console.error(`‚ùå Produto ${code} sem estoque`);
        results.push({ code, success: false, error: 'Produto sem estoque' });
        continue;
      }

      // 3. Buscar pedido existente N√ÉO pago do mesmo dia
      // IMPORTANTE: Filtrar apenas BAZAR e MANUAL, excluir LIVE
      console.log('\nüîé ===== BUSCANDO PEDIDO EXISTENTE =====');
      console.log('üìã Tenant ID:', tenant_id);
      console.log('üìã Telefone normalizado:', phoneNormalized);
      console.log('üìã Data:', today);
      console.log('üìã Tipos aceitos: BAZAR, MANUAL');
      console.log('üìã Status: n√£o pago');
      
      const { data: existingOrders, error: orderSearchError } = await supabase
        .from('orders')
        .select('*')
        .eq('tenant_id', tenant_id)
        .eq('customer_phone', phoneNormalized)
        .eq('event_date', today)
        .eq('is_paid', false)
        .in('event_type', ['BAZAR', 'MANUAL'])
        .order('created_at', { ascending: false })
        .limit(1);

      if (orderSearchError) {
        console.error('‚ùå Erro ao buscar pedido:', orderSearchError);
        results.push({ code, success: false, error: 'Erro ao buscar pedido' });
        continue;
      }
      
      console.log('üìä Resultado da busca:', existingOrders?.length || 0, 'pedido(s) encontrado(s)');
      if (existingOrders && existingOrders.length > 0) {
        console.log('‚úÖ Pedido existente #', existingOrders[0].id);
        console.log('   - Tipo:', existingOrders[0].event_type);
        console.log('   - Telefone no DB:', existingOrders[0].customer_phone);
        console.log('   - Total atual: R$', existingOrders[0].total_amount);
      }
      console.log('===== FIM BUSCA PEDIDO =====\n');

      const qty = 1; // Quantidade padr√£o
      const subtotal = product.price * qty;
      let orderId: number;
      let cartId: number | null = null;

      // 4. Usar pedido existente OU criar novo pedido BAZAR
      if (existingOrders && existingOrders.length > 0) {
        const existingOrder = existingOrders[0];
        orderId = existingOrder.id;
        cartId = existingOrder.cart_id;
        
        console.log(`‚úÖ Pedido existente encontrado: #${orderId}`);
        console.log(`   Tipo: ${existingOrder.event_type}`);
        console.log(`   Total atual: R$ ${existingOrder.total_amount}`);

        // Atualizar total do pedido
        const newTotal = parseFloat(existingOrder.total_amount) + subtotal;
        const { error: updateError } = await supabase
          .from('orders')
          .update({ total_amount: newTotal })
          .eq('id', orderId);

        if (updateError) {
          console.error('‚ùå Erro ao atualizar pedido:', updateError);
          results.push({ code, success: false, error: 'Erro ao atualizar pedido' });
          continue;
        }

        console.log(`‚úÖ Total atualizado para: R$ ${newTotal}`);
      } else {
        // Criar novo pedido do tipo BAZAR
        console.log('üìù Criando novo pedido BAZAR...');
        
        const { data: newOrder, error: orderError } = await supabase
          .from('orders')
          .insert([{
            tenant_id,
            customer_phone: phoneNormalized,
            event_type: 'BAZAR',
            event_date: today,
            total_amount: subtotal,
            is_paid: false,
            whatsapp_group_name: group_name || null
          }])
          .select()
          .single();

        if (orderError) {
          console.error('‚ùå Erro ao criar pedido:', orderError);
          results.push({ code, success: false, error: 'Erro ao criar pedido' });
          continue;
        }

        orderId = newOrder.id;
        console.log(`‚úÖ Novo pedido BAZAR criado: #${orderId}`);
      }

      // 5. Criar carrinho se n√£o existir
      if (!cartId) {
        console.log('üõí Criando carrinho...');
        
        const { data: newCart, error: cartError } = await supabase
          .from('carts')
          .insert({
            tenant_id,
            customer_phone: phoneNormalized,
            event_type: 'BAZAR',
            event_date: today,
            status: 'OPEN',
            whatsapp_group_name: group_name || null
          })
          .select()
          .single();

        if (cartError) {
          console.error('‚ùå Erro ao criar carrinho:', cartError);
          results.push({ code, success: false, error: 'Erro ao criar carrinho' });
          continue;
        }

        cartId = newCart.id;

        // Atualizar pedido com cart_id
        await supabase
          .from('orders')
          .update({ cart_id: cartId })
          .eq('id', orderId);

        console.log(`‚úÖ Carrinho criado: #${cartId}`);
      }

      // 6. Verificar se produto j√° est√° no carrinho
      const { data: existingCartItem } = await supabase
        .from('cart_items')
        .select('*')
        .eq('cart_id', cartId)
        .eq('product_id', product.id)
        .maybeSingle();

      if (existingCartItem) {
        // Atualizar quantidade do item existente
        console.log(`üîÑ Produto j√° est√° no carrinho, atualizando quantidade...`);
        
        const { error: updateCartError } = await supabase
          .from('cart_items')
          .update({
            qty: existingCartItem.qty + qty,
            unit_price: product.price
          })
          .eq('id', existingCartItem.id);

        if (updateCartError) {
          console.error('‚ùå Erro ao atualizar item do carrinho:', updateCartError);
          results.push({ code, success: false, error: 'Erro ao atualizar carrinho' });
          continue;
        }

        console.log(`‚úÖ Quantidade atualizada: ${existingCartItem.qty} ‚Üí ${existingCartItem.qty + qty}`);
      } else {
        // Adicionar novo item ao carrinho
        console.log(`‚ûï Adicionando produto ao carrinho...`);
        
        const { error: cartItemError } = await supabase
          .from('cart_items')
          .insert({
            tenant_id,
            cart_id: cartId,
            product_id: product.id,
            qty: qty,
            unit_price: product.price,
            printed: false
          });

        if (cartItemError) {
          console.error('‚ùå Erro ao adicionar item ao carrinho:', cartItemError);
          results.push({ code, success: false, error: 'Erro ao adicionar ao carrinho' });
          continue;
        }

        console.log(`‚úÖ Produto adicionado ao carrinho`);
      }

      // 7. Atualizar estoque do produto
      console.log(`üì¶ Atualizando estoque: ${product.stock} ‚Üí ${product.stock - qty}`);
      
      const { error: stockError } = await supabase
        .from('products')
        .update({ stock: product.stock - qty })
        .eq('id', product.id);

      if (stockError) {
        console.error('‚ö†Ô∏è Erro ao atualizar estoque (n√£o bloqueante):', stockError);
      } else {
        console.log(`‚úÖ Estoque atualizado`);
      }

      // 8. Enviar mensagem WhatsApp de confirma√ß√£o
      console.log(`üì§ Enviando confirma√ß√£o via WhatsApp...`);
      
      try {
        const sendMessageResponse = await supabase.functions.invoke('whatsapp-send-item-added', {
          body: {
            tenant_id,
            customer_phone: phoneNormalized,
            product_name: product.name,
            product_code: product.code,
            quantity: qty,
            unit_price: product.price
          }
        });

        if (sendMessageResponse.error) {
          console.error('‚ùå Erro ao enviar WhatsApp:', sendMessageResponse.error);
        } else {
          console.log('‚úÖ Mensagem WhatsApp enviada');
        }
      } catch (error) {
        console.error('‚ùå Erro ao chamar edge function WhatsApp:', error);
      }

      console.log(`‚úÖ ===== C√ìDIGO ${code} PROCESSADO COM SUCESSO =====\n`);

      results.push({
        code,
        success: true,
        product: product.name,
        orderId,
        quantity: qty,
        total: subtotal
      });
    }

    console.log('üéâ ===== PROCESSAMENTO CONCLU√çDO =====\n');

    return new Response(
      JSON.stringify({
        success: true,
        message: `${codes.length} c√≥digo(s) processado(s)`,
        results
      }),
      { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );

  } catch (error) {
    console.error('\nüí• ===== ERRO NO PROCESSAMENTO =====');
    console.error('Tipo:', error.name);
    console.error('Mensagem:', error.message);
    console.error('Stack:', error.stack);
    console.error('===== FIM DO ERRO =====\n');
    
    return new Response(
      JSON.stringify({ error: error.message }),
      { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );
  }
});
