<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Melhor Envio - OrderZaps</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .response {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .quote-result {
            background-color: #e7f3ff;
            border: 1px solid #b8daff;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .service-option {
            background: white;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            cursor: pointer;
        }
        .service-option:hover {
            background-color: #f8f9fa;
        }
        .service-option.selected {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
    </style>
</head>
<body>
    <h1>üöö Teste Melhor Envio - OrderZaps</h1>
    
    <!-- Configura√ß√£o -->
    <div class="container">
        <h2>‚öôÔ∏è Configura√ß√£o</h2>
        
        <div class="form-group">
            <label for="tenantId">Tenant ID:</label>
            <input type="text" id="tenantId" placeholder="UUID do tenant">
        </div>
        
        <div class="form-group">
            <label for="orderId">Order ID para teste:</label>
            <input type="number" id="orderId" value="24" placeholder="ID do pedido">
        </div>
        
        <div class="form-group">
            <label for="environment">Ambiente:</label>
            <select id="environment">
                <option value="sandbox">Sandbox</option>
                <option value="production">Produ√ß√£o</option>
            </select>
        </div>
    </div>

    <!-- Cota√ß√£o de Frete -->
    <div class="container">
        <h2>üìã 1. Cota√ß√£o de Frete</h2>
        
        <div class="form-group">
            <label for="cepOrigem">CEP Origem:</label>
            <input type="text" id="cepOrigem" value="31575060" placeholder="CEP apenas n√∫meros">
        </div>
        
        <div class="form-group">
            <label for="cepDestino">CEP Destino:</label>
            <input type="text" id="cepDestino" value="01310100" placeholder="CEP apenas n√∫meros">
        </div>
        
        <div class="form-group">
            <label for="peso">Peso (kg):</label>
            <input type="number" id="peso" value="0.3" step="0.1" placeholder="Peso em kg">
        </div>
        
        <div style="display: flex; gap: 10px;">
            <div class="form-group" style="flex: 1;">
                <label for="largura">Largura (cm):</label>
                <input type="number" id="largura" value="16" placeholder="cm">
            </div>
            <div class="form-group" style="flex: 1;">
                <label for="altura">Altura (cm):</label>
                <input type="number" id="altura" value="4" placeholder="cm">
            </div>
            <div class="form-group" style="flex: 1;">
                <label for="comprimento">Comprimento (cm):</label>
                <input type="number" id="comprimento" value="24" placeholder="cm">
            </div>
        </div>
        
        <button onclick="cotarFrete()" id="btnCotar">Cotar Frete</button>
        
        <div id="quoteResult"></div>
    </div>

    <!-- Cria√ß√£o de Envio -->
    <div class="container">
        <h2>üì¶ 2. Criar Envio</h2>
        
        <button onclick="criarEnvio()" id="btnCriarEnvio">Criar Envio</button>
        
        <div id="shipmentResult"></div>
    </div>

    <!-- Gerar Link de Pagamento -->
    <div class="container">
        <h2>üí≥ 3. Gerar Link de Pagamento</h2>
        
        <button onclick="gerarLinkPagamento()" id="btnGerarLink">Gerar Link MP</button>
        
        <div id="paymentResult"></div>
    </div>

    <!-- Download de Etiqueta -->
    <div class="container">
        <h2>üè∑Ô∏è 4. Download Etiqueta</h2>
        
        <button onclick="baixarEtiqueta()" id="btnBaixarEtiqueta">Baixar Etiqueta PDF</button>
        
        <div id="labelResult"></div>
    </div>

    <!-- Rastreamento -->
    <div class="container">
        <h2>üìç 5. Rastreamento</h2>
        
        <button onclick="rastrearEnvio()" id="btnRastrear">Rastrear Envio</button>
        
        <div id="trackingResult"></div>
    </div>

    <!-- Logs -->
    <div class="container">
        <h2>üìù Logs de Resposta</h2>
        <div id="logs" class="response"></div>
    </div>

    <script>
        // Fun√ß√£o para adicionar log
        function addLog(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleString();
            const logClass = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            
            logs.innerHTML += `[${timestamp}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
        }

        // Fun√ß√£o gen√©rica para chamadas √† API
        async function callAPI(endpoint, data, description) {
            try {
                addLog(`üîÑ ${description}...`);
                addLog(`üì° URL: https://hxtbsieodbtzgcvvkeqx.supabase.co/functions/v1/${endpoint}`);
                addLog(`üì§ Payload: ${JSON.stringify(data, null, 2)}`);
                
                const response = await fetch(`https://hxtbsieodbtzgcvvkeqx.supabase.co/functions/v1/${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'User-Agent': 'OrderZaps (contato@orderzaps.com)'
                    },
                    body: JSON.stringify(data)
                });

                addLog(`üìä Status: ${response.status} ${response.statusText}`);
                addLog(`üìã Headers: ${JSON.stringify([...response.headers.entries()], null, 2)}`);

                const responseText = await response.text();
                addLog(`üìÑ Raw Response: ${responseText}`);
                
                let responseData;
                
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    responseData = { raw: responseText, parse_error: e.message };
                }

                if (!response.ok) {
                    addLog(`‚ùå ${description} falhou: ${response.status} - ${JSON.stringify(responseData, null, 2)}`, 'error');
                    return { success: false, error: responseData, status: response.status };
                }

                addLog(`‚úÖ ${description} bem-sucedido!`, 'success');
                addLog(`üìÑ Parsed Response: ${JSON.stringify(responseData, null, 2)}`);
                
                return { success: true, data: responseData };

            } catch (error) {
                addLog(`üí• Erro de rede/conex√£o em ${description}: ${error.message}`, 'error');
                addLog(`üîç Stack trace: ${error.stack}`, 'error');
                return { success: false, error: error.message, network_error: true };
            }
        }

        // 1. Cota√ß√£o de Frete
        async function cotarFrete() {
            const btnCotar = document.getElementById('btnCotar');
            btnCotar.disabled = true;
            btnCotar.textContent = 'Cotando...';

            const payload = {
                to_postal_code: document.getElementById('cepDestino').value.replace(/\D/g, ''),
                products: [{
                    weight: parseFloat(document.getElementById('peso').value),
                    width: parseInt(document.getElementById('largura').value),
                    height: parseInt(document.getElementById('altura').value),
                    length: parseInt(document.getElementById('comprimento').value),
                    insurance_value: 50
                }]
            };

            const result = await callAPI('melhor-envio-shipping', payload, 'Cota√ß√£o de frete');
            
            const quoteDiv = document.getElementById('quoteResult');
            
            if (result.success && result.data.shipping_options) {
                let html = '<h3>Op√ß√µes de Frete Dispon√≠veis:</h3>';
                result.data.shipping_options.forEach((option, index) => {
                    html += `
                        <div class="service-option" onclick="selectService(${index}, '${option.service_id}')">
                            <strong>${option.service_name}</strong> - ${option.company}<br>
                            Pre√ßo: R$ ${option.price.toFixed(2)}<br>
                            Prazo: ${option.delivery_time} dias √∫teis
                        </div>
                    `;
                });
                quoteDiv.innerHTML = html;
            } else {
                quoteDiv.innerHTML = `<div class="error">Erro na cota√ß√£o: ${JSON.stringify(result.error || 'Erro desconhecido')}</div>`;
            }

            btnCotar.disabled = false;
            btnCotar.textContent = 'Cotar Frete';
        }

        let selectedServiceId = null;
        function selectService(index, serviceId) {
            // Remove sele√ß√£o anterior
            document.querySelectorAll('.service-option').forEach(el => el.classList.remove('selected'));
            // Adiciona sele√ß√£o atual
            document.querySelectorAll('.service-option')[index].classList.add('selected');
            selectedServiceId = serviceId;
            addLog(`üéØ Servi√ßo selecionado: ${serviceId}`);
        }

        // 2. Criar Envio
        async function criarEnvio() {
            const tenantId = document.getElementById('tenantId').value;
            const orderId = document.getElementById('orderId').value;
            
            if (!tenantId || !orderId) {
                alert('Preencha Tenant ID e Order ID');
                return;
            }

            const btnCriar = document.getElementById('btnCriarEnvio');
            btnCriar.disabled = true;
            btnCriar.textContent = 'Criando...';

            const payload = {
                action: 'create_shipment',
                order_id: parseInt(orderId),
                tenant_id: tenantId
            };

            const result = await callAPI('melhor-envio-labels', payload, 'Cria√ß√£o de envio');
            
            const shipmentDiv = document.getElementById('shipmentResult');
            
            if (result.success) {
                shipmentDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Envio criado com sucesso!</h4>
                        <pre>${JSON.stringify(result.data, null, 2)}</pre>
                    </div>
                `;
            } else {
                shipmentDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Falha na cria√ß√£o do envio</h4>
                        <pre>${JSON.stringify(result.error, null, 2)}</pre>
                    </div>
                `;
            }

            btnCriar.disabled = false;
            btnCriar.textContent = 'Criar Envio';
        }

        // 3. Gerar Link de Pagamento
        async function gerarLinkPagamento() {
            const tenantId = document.getElementById('tenantId').value;
            const orderId = document.getElementById('orderId').value;
            
            if (!tenantId || !orderId) {
                alert('Preencha Tenant ID e Order ID');
                return;
            }

            const btnGerar = document.getElementById('btnGerarLink');
            btnGerar.disabled = true;
            btnGerar.textContent = 'Gerando...';

            const payload = {
                action: 'generate_payment_link',
                order_id: parseInt(orderId),
                tenant_id: tenantId
            };

            const result = await callAPI('melhor-envio-labels', payload, 'Gera√ß√£o de link de pagamento');
            
            const paymentDiv = document.getElementById('paymentResult');
            
            if (result.success) {
                paymentDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Link gerado!</h4>
                        <p><a href="${result.data.payment_link}" target="_blank">${result.data.payment_link}</a></p>
                    </div>
                `;
            } else {
                paymentDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Falha na gera√ß√£o do link</h4>
                        <pre>${JSON.stringify(result.error, null, 2)}</pre>
                    </div>
                `;
            }

            btnGerar.disabled = false;
            btnGerar.textContent = 'Gerar Link MP';
        }

        // 4. Baixar Etiqueta
        async function baixarEtiqueta() {
            const tenantId = document.getElementById('tenantId').value;
            const orderId = document.getElementById('orderId').value;
            
            if (!tenantId || !orderId) {
                alert('Preencha Tenant ID e Order ID');
                return;
            }

            const btnBaixar = document.getElementById('btnBaixarEtiqueta');
            btnBaixar.disabled = true;
            btnBaixar.textContent = 'Baixando...';

            const payload = {
                action: 'download_label',
                order_id: parseInt(orderId),
                tenant_id: tenantId
            };

            const result = await callAPI('melhor-envio-labels', payload, 'Download de etiqueta');
            
            const labelDiv = document.getElementById('labelResult');
            
            if (result.success) {
                labelDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Etiqueta baixada!</h4>
                        <p><a href="${result.data.label_url}" target="_blank">üè∑Ô∏è Abrir PDF da Etiqueta</a></p>
                    </div>
                `;
            } else {
                labelDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Falha no download</h4>
                        <pre>${JSON.stringify(result.error, null, 2)}</pre>
                    </div>
                `;
            }

            btnBaixar.disabled = false;
            btnBaixar.textContent = 'Baixar Etiqueta PDF';
        }

        // 5. Rastrear Envio
        async function rastrearEnvio() {
            const tenantId = document.getElementById('tenantId').value;
            const orderId = document.getElementById('orderId').value;
            
            if (!tenantId || !orderId) {
                alert('Preencha Tenant ID e Order ID');
                return;
            }

            const btnRastrear = document.getElementById('btnRastrear');
            btnRastrear.disabled = true;
            btnRastrear.textContent = 'Rastreando...';

            const payload = {
                action: 'track_shipment',
                order_id: parseInt(orderId),
                tenant_id: tenantId
            };

            const result = await callAPI('melhor-envio-labels', payload, 'Rastreamento de envio');
            
            const trackingDiv = document.getElementById('trackingResult');
            
            if (result.success) {
                trackingDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Rastreamento obtido!</h4>
                        <pre>${JSON.stringify(result.data.tracking, null, 2)}</pre>
                    </div>
                `;
            } else {
                trackingDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Falha no rastreamento</h4>
                        <pre>${JSON.stringify(result.error, null, 2)}</pre>
                    </div>
                `;
            }

            btnRastrear.disabled = false;
            btnRastrear.textContent = 'Rastrear Envio';
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            addLog('üöÄ Sistema de teste do Melhor Envio iniciado');
            addLog('üìã Preencha o Tenant ID e Order ID para come√ßar os testes');
            addLog('üîó Base URL: https://hxtbsieodbtzgcvvkeqx.supabase.co/functions/v1/');
            
            // Auto-detectar tenant ID se estiver na URL
            const params = new URLSearchParams(window.location.search);
            const tenantFromUrl = params.get('tenant_id');
            if (tenantFromUrl) {
                document.getElementById('tenantId').value = tenantFromUrl;
                addLog(`üéØ Tenant ID detectado na URL: ${tenantFromUrl}`, 'success');
            }
        });
    </script>
</body>
</html>